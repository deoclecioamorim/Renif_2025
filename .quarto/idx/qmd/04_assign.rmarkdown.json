{"title":"Atribuição","markdown":{"yaml":{"title":"Atribuição","author":"Deoclecio J. Amorim (CENA), João Paulo Sena-Souza (Unimontes) e Paulo José Duarte Neto (UFRPE)","format":{"html":{"page-layout":"full","toc":true,"toc-location":"left","fig-width":5,"fig-height":5}},"knitr":{"opts_chunk":{"fig-align":"center"}}},"headingText":"Ajuste global para gráficos","containsRefs":false,"markdown":"\n\n```{r}\n#| include: false\n\nlibrary(knitr)\nopts_knit$set(global.par = TRUE)\npar(mar = c(5, 5, 1, 1))\n\n```\n\n\n## Configuração inicial\n\n```{r config}\n# Limpar área de trabalho\nrm(list = ls())      \ngc(reset = TRUE)     \ngraphics.off()       \n\n#Pacotes necessários\nif(!require(readxl))install.packages(\"readxl\", dep = TRUE, quiet = TRUE)\nif(!require(tidyverse))install.packages(\"tidyverse\", dep = TRUE, quiet = TRUE)\nif(!require(terra))install.packages(\"terra\", dep = TRUE, quiet = TRUE)\nif(!require(geodata))install.packages(\"geodata\", dep = TRUE, quiet = TRUE)\nif(!require(geobr))install.packages(\"geobr\", dep = TRUE, quiet = TRUE)\nif(!require(sf))install.packages(\"sf\", dep = TRUE, quiet = TRUE)\nif(!require(sp))install.packages(\"sp\", dep = TRUE, quiet = TRUE)\nif(!require(here))install.packages(\"here\", dep = TRUE, quiet = TRUE)\nif(!require(assignR))install.packages(\"assignR\", dep = TRUE, quiet = TRUE)\nif(!require(viridis))install.packages(\"viridis\", dep = TRUE, quiet = TRUE)\n\n\n```\n\n## Introdução\n\nO objetivo final com os isoscapes é usá-los para inferir a provável origem geográfica \ndo material de estudo.\n\nVamos supor o seguinte cenário: Estudar se uma determinada amostra provem do estado do \nAmazonas ou do Mato grosso. Vamos usar a isoscape gerada pelo modelo RF.\n\n\n```{r fus}\n\n# 1) Ler o shapefile das UFs (Amazônia Legal)\nfu <- terra::vect(here::here(\"shapefiles\", \"fu.shp\"))\nfu <- terra::project(fu, \"EPSG:4674\")\n\ncrs(fu)\n\n# Veja os nomes de campos disponíveis para filtrar\n# names(fu)\n\nfu.names <- c(\"Amazonas\", \"Mato Grosso\")\nfus <- fu[fu$ADM1_PT %in% fu.names]\n\n# 2) Ler isoscape gerada pelo modelo RF\niso_files <- list.files(path = here::here(\"isoscape\"), pattern = \"\\\\.tif$\", full.names = TRUE)\niso_d13   <- terra::rast(iso_files)\n\n# Conferir CRS\ncrs(fu)\ncrs(iso_d13)\nsame.crs(fu, iso_d13)\n\nfus.mu <- extract(iso_d13[[1]], fus, \"mean\", na.rm = TRUE)\nfus.mu$ID = fu.names\nfus.mu\n\n```\n\nOs valores médios `d13C_wood` previstos pelos nossos mapas isotópicos para os dois estados diferem em cerca de 0.97% (por mil). \n\n- Com base nisso é possivel determinar se uma amostra provem de algum desses estados? Por exemplo,\na amostra 103 provem do Amazonas ou Mato Grosso?\n\n```{r unknown}\namz_var_clim <- readxl::read_excel(here::here(\"dados\", \"madeira_amz_var_clim.xlsx\"), sheet = 1)\nhead(amz_var_clim) #leitura das primeiras 6 linhas\nstr(amz_var_clim) #Estrutura dos dados\n\n\n#Tratando NAs\nd13.amz <- amz_var_clim[!is.na(amz_var_clim$d13C_wood), ]\n\n# Adicionando ID\nd13.amz$ID <- 1:nrow(d13.amz)\n\nd13.amz <- d13.amz %>% relocate(ID, .before = 1)\n\nunknown <- d13.amz[d13.amz$ID== 103,]\nunknown$d13C_wood\n```\n\nDado o valor medido, como você julgaria qual unidade é a origem mais provável? A maioria dos algoritmos de classificação simples usa uma métrica de distância para avaliar a similaridade entre o valor da amostra e as classes possíveis, atribuindo então a amostra à classe mais similar. Por exemplo:\n\n```{r invDiff}\nfus.mu$inv.diff <- 1 / abs(unknown$d13C_wood - fus.mu[, 2])\nfus.mu\n```\n\nCom base no inverso da distância podemos admitir que é mais coerente essa amostra\nser do Amazonas. Vejamos mais alguns detalhes:\n\n:::{#fuDist}\n```{r fuDist}\n#| fig-width: 6\n#| fig-height: 4\n\ncols = viridis(2, begin = 0.2, end = 0.8)\nfus.all = extract(iso_d13, fus)\nd1 = density(fus.all[fus.all$ID == 1, 2], na.rm = TRUE)\nd2 = density(fus.all[fus.all$ID == 2, 2], na.rm = TRUE)\nplot(d1, xlim = range(fus.all[, 2], na.rm = TRUE), \n     ylim = range(c(d1$y, d2$y)), main = \"\", \n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), col = cols[1], lwd = 3)\nlines(d2, col = cols[2], lwd = 3)\nabline(v = unknown$d13C_wood, lwd = 3, lty = 3)\nlegend(\"topleft\", fu.names, lwd = 3, col = cols, bty = \"n\")\n```\n:::\n\nNote que agora as coisas parecem um pouco diferentes. O que não percebemos antes, quando avaliamos apenas as médias, é que as `d13C_wood` previsões para Mato Grosso estão restritas a uma faixa estreita de valores, enquanto as do Amazonas são muito mais dispersas. Como resultado, o valor da amostra desconhecida tem, na verdade, uma probabilidade maior de ocorrer no Amazonas. Podemos avaliar a diferença entre as probabilidades extraindo a densidade de probabilidade do valor da amostra por mil dos kernels para as duas regiões:\n\n:::{#fuRatio}\n```{r fuRatio}\np1 <- d1$y[which.min(abs(unknown$d13C_wood - d1$x))]\np2 <- d2$y[which.min(abs(unknown$d13C_wood - d2$x))]\ncat(\"PD Amazonas = \", p1, \"\\nPD Mato Grosso = \", p2, \"\\nRatio = \", p1 / p2)\n```\n:::\n\nIsso demonstra que a probabilidade de encontrar esse valor no Amazonas é muito maior do que no Mato Grosso, levantando a hipotese que realmente o Amazonas seja a região de origem mais provável.\n\nPodemos ir um passo além, no entanto, aplicando o Teorema de Bayes para fazer uma afirmação quantitativa sobre a probabilidade de cada unidade ser a verdadeira região de origem, partirmos das seguintes premissas:\n\n1) Nossa amostra desconhecida deve ter vindo de um dos dois estados, e\n\n2) Antes de considerarmos nossos dados isotópicos, ambos os estados têm a mesma probabilidade de serem a verdadeira origem.\n\nO Teorema de Bayes nos diz que a probabilidade de uma determinada região ser a verdadeira região de origem é igual à probabilidade de observarmos nossos dados isotópicos nessa região dividida pela probabilidade de observarmos os dados em qualquer uma das regiões. Acabamos de determinar as probabilidades para os dados acima, o que torna esse cálculo muito fácil:\n\n```{r fuPost}\ndata.frame(\"Region\" = fu.names, \"Probalidade_posteiro\" = \n             c(p1 / sum(p1, p2), p2 / sum(p1, p2)))\n```\n\nA probabilidade posterior é a probabilidade após considerarmos nossas novas evidências (isotópicas) e, como você pode ver aqui, ela sugere que há uma alta probabilidade (99%) de que nossa amostra desconhecida seja do Amazonas e não do Mato Grosso. Se quisermos 'atribuir' a amostra a uma região de origem mais provável, escolheríamos o Amazonas.\n\nResumindo nosso exemplo, a chave para atribuir a amostra a uma região geográfica é encontrar a probabilidade de nossa evidência (o valor da amostra `d13C_wood`) ocorrer em cada uma de nossas potenciais regiões de origem. Com essa informação, podemos aplicar o Teorema de Bayes para encontrar a probabilidade de cada região ser a verdadeira origem.\n\n\n## Isoscapes baseados em probabilidade\n\nUsando a isoscape gerada pelo modelo RF vamos considerar cada célula da grade no mapa de isótopos separadamente como uma possível localização de onde nossa amostra pode ter se originado. \n\nUma das implicações dessa abordagem é que agora estamos considerando um número muito grande de possíveis locais de origem. Esse número dependerá da extensão e da resolução do nosso mapa isotópico, mas, neste exemplo, o número é:\n\n```{r nCell}\nsum(!is.na(values(iso_d13[[1]])))\n\n# Cada pixel tem aproximadamente 85 km2\nterra::res(iso_d13[[1]])\n```\nConsequentemente, a probabilidade de qualquer célula da grade ser a localização real de origem será bastante pequena. Por exemplo, se nossa suposição inicial for que cada célula da grade tem a mesma probabilidade de ser a verdadeira origem da amostra, cada célula terá uma probabilidade de:\n\n```{r cellProb}\n1 / sum(!is.na(values(iso_d13[[1]])))\n```\nEsses pequenos valores de probabilidade confundem um pouco, mas podemos ver aqui como eles surgem e que são esperados. Em geral, não estaremos interessados nos valores de probabilidade em si, mas na magnitude relativa das probabilidades para diferentes locais.\n\nPara aplicar nosso método baseado em probabilidade às células da grade do mapa de isótopos, precisamos conhecer as distribuições de probabilidade dos `d13C_wood` valores em cada célula. Nesse caso, vamos assumir a suposição de normalidade.\n\nPara realizar a análise (e ao longo do restante desta vinheta), usaremos funções do\n[`assignR` package](https://cran.r-project.org/package=assignR).\n\n```{r pdRaster}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nsam <- data.frame(\"ID\" = unknown$ID, \"d13C\" = unknown$d13C_wood)\np.map1 <-  pdRaster(iso_d13, sam, genplot = FALSE)\nuk.sp <- vect(unknown, geom = c(\"x\", \"y\"), crs = \"EPSG:4674\")\nfu.sub <- fu[fu$ADM1_PT %in% fu.names]\n\nplot(p.map1, axes = FALSE)\nlines(fu.sub, lwd = 2)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 2, lwd = 2, bg = \"white\")\n```\nO mapa mostra a localização de origem verdadeira e conhecida desta amostra. É possível observar que ela não se encontra em uma região com probabilidade posterior particularmente alta. Também não está na região com as probabilidades mais baixas. Podemos extrair o valor real para esta localização, que se situa no meio do intervalo obtido na análise:\n\n```{r rastProb}\nextract(p.map1, uk.sp)\n```\n\n\n\n## Inferência\n\nAlgumas perguntas:\n\n- 1) *De onde veio a amostra*? \n\n- 2) *Quais são os locais de origem mais prováveis*?\n\nA função `qtlRaster()` oferece duas opções para tentar responder essas questões,\na primeira (e padrão) baseada na área do mapa:\n\n```{r qt1}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nqt1 <- qtlRaster(p.map1, threshold =0.5, genplot = FALSE)\n\nplot(qt1, axes = FALSE)\nlines(fu.sub)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 1.5, lwd = 2, bg = \"white\")\n```\n\nAqui extrairmos 50% da área de estudo, gerando mapas que mostram os 50% das \ncélulas da grade com a maior probabilidade posterior a amostra.\n\nA segunda opção de atribuição é um pouco menos arbitrária e envolve a seleção das células mais prováveis da malha isotópica que representam coletivamente uma certa quantidade da probabilidade posterior. Neste caso, escolhemos um valor de 0,95. Assim, podemos interpretar diretamente o resultado: tendo em conta os dados e os pressupostos da nossa análise, existe uma probabilidade de 95% de a amostra provir da área selecionada.\n\n\n\n:::{#qt2}\n```{r qt2}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nqt2<-qtlRaster(p.map1, threshold = 0.95, thresholdType = \"prob\", genplot = FALSE)\n\nplot(qt2, axes = FALSE)\nlines(fu.sub)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 1.5, lwd = 2)\n\nextract(qt2, uk.sp)\n```\n:::\n\nComo você pode ver, precisamos selecionar mais de 50% da área de estudo para atingir nosso limiar de probabilidade de 95%. Também é possível observar que, neste caso, a verdadeira localização de origem está incluída na região de atribuição.  Sempre haverá muitos locais onde um determinado valor pode ocorrer, mas pode ser bastante óbvio quando o valor de uma amostra não corresponde bem a um determinado local.\n\nUsando a razão de chances podemos responder Qual unidade federativa é a localização de origem mais provável, Amazonas ou Mato Grosso? \n\n\n```{r odds}\noddsRatio(p.map1, fu.sub)\n```\nHá dois pontos a observar aqui:\n\n- A razão de chances indica que é 1,7 vezes mais provável que a amostra tenha vindo do Amazonas (que por acaso é o verdadeiro local de origem).\n\n\n```{r pdDist}\n#| fig-width: 6\n#| fig-height: 4\n\npts = sample(which(fus.all$ID == 1), 5)\npts = c(pts, sample(which(fus.all$ID == 2), 5))\n\nplot(NULL, xlim = c(-32, -26), ylim = c(0, 0.7), \n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), ylab = \"Density\")\n\nfor(i in pts){\n  lines(density(rnorm(1e6, fus.all[i, 2], fus.all[i, 3])), lwd = 3, \n        col = cols[fus.all[i, 1]])\n}\nabline(v = unknown$d13C_wood, lwd = 3, lty = 3)\nlegend(\"topleft\", fu.names, lwd = 3, col = cols, bty = \"n\")\n\n```\n\n\nNossa análise de probabilidade de isótopos adiciona um fator importante que ignoramos implicitamente na análise de classificação original: a incerteza da previsão. Lembre-se de que nossos modelos de isótopos explicam apenas cerca de metade da `d13C_wood` variabilidade. A variação restante provém de duas fontes:\n\n- Erro do modelo - nosso modelo é imperfeito e não representa perfeitamente o padrão de `d13C_wood` valores médios na área de estudo.\n\n- Variabilidade local - árvores individuais que vivem no mesmo local podem apresentar valores que variam em vários por mil. Por exemplo, aqui está a distribuição de valores para árvores individuais da mesma família e local de coleta que nossa amostra de teste desconhecida:\n\n\n```{r variance}\nplot(density(d13.amz$d13C_wood[d13.amz$Family == unknown$Family & \n                               d13.amz$Site == unknown$Site]),\n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), main = \"\", lwd = 2)\n```\nSe quisermos avaliar se uma amostra pode ter vindo deste local com base em seu `d13C_wood` valor, é importante conhecer o valor médio do local, mas também precisamos considerar a dispersão: claramente, valores que variam de -34 a -26 por mil são plausíveis neste local.\n\n### Qualidade da atribuição\n\n\n```{r QA}\n#| output: false\n\nknown <- d13.amz[d13.amz$Family == \"Burseraceae\", c(\"x\", \"y\", \"d13C_wood\")]\nknown <- vect(known, geom = c(\"x\", \"y\"), crs = \"EPSG:4674\")\nqa1 <- QA(known, iso_d13, bySite = FALSE, recal = FALSE)\n```\n```{r plotQA}\n#| layout-ncol: 2\n\nplot(qa1)\n```\n\n\n\n\n\n\n","srcMarkdownNoYaml":"\n\n```{r}\n#| include: false\n\n# Ajuste global para gráficos\nlibrary(knitr)\nopts_knit$set(global.par = TRUE)\npar(mar = c(5, 5, 1, 1))\n\n```\n\n\n## Configuração inicial\n\n```{r config}\n# Limpar área de trabalho\nrm(list = ls())      \ngc(reset = TRUE)     \ngraphics.off()       \n\n#Pacotes necessários\nif(!require(readxl))install.packages(\"readxl\", dep = TRUE, quiet = TRUE)\nif(!require(tidyverse))install.packages(\"tidyverse\", dep = TRUE, quiet = TRUE)\nif(!require(terra))install.packages(\"terra\", dep = TRUE, quiet = TRUE)\nif(!require(geodata))install.packages(\"geodata\", dep = TRUE, quiet = TRUE)\nif(!require(geobr))install.packages(\"geobr\", dep = TRUE, quiet = TRUE)\nif(!require(sf))install.packages(\"sf\", dep = TRUE, quiet = TRUE)\nif(!require(sp))install.packages(\"sp\", dep = TRUE, quiet = TRUE)\nif(!require(here))install.packages(\"here\", dep = TRUE, quiet = TRUE)\nif(!require(assignR))install.packages(\"assignR\", dep = TRUE, quiet = TRUE)\nif(!require(viridis))install.packages(\"viridis\", dep = TRUE, quiet = TRUE)\n\n\n```\n\n## Introdução\n\nO objetivo final com os isoscapes é usá-los para inferir a provável origem geográfica \ndo material de estudo.\n\nVamos supor o seguinte cenário: Estudar se uma determinada amostra provem do estado do \nAmazonas ou do Mato grosso. Vamos usar a isoscape gerada pelo modelo RF.\n\n\n```{r fus}\n\n# 1) Ler o shapefile das UFs (Amazônia Legal)\nfu <- terra::vect(here::here(\"shapefiles\", \"fu.shp\"))\nfu <- terra::project(fu, \"EPSG:4674\")\n\ncrs(fu)\n\n# Veja os nomes de campos disponíveis para filtrar\n# names(fu)\n\nfu.names <- c(\"Amazonas\", \"Mato Grosso\")\nfus <- fu[fu$ADM1_PT %in% fu.names]\n\n# 2) Ler isoscape gerada pelo modelo RF\niso_files <- list.files(path = here::here(\"isoscape\"), pattern = \"\\\\.tif$\", full.names = TRUE)\niso_d13   <- terra::rast(iso_files)\n\n# Conferir CRS\ncrs(fu)\ncrs(iso_d13)\nsame.crs(fu, iso_d13)\n\nfus.mu <- extract(iso_d13[[1]], fus, \"mean\", na.rm = TRUE)\nfus.mu$ID = fu.names\nfus.mu\n\n```\n\nOs valores médios `d13C_wood` previstos pelos nossos mapas isotópicos para os dois estados diferem em cerca de 0.97% (por mil). \n\n- Com base nisso é possivel determinar se uma amostra provem de algum desses estados? Por exemplo,\na amostra 103 provem do Amazonas ou Mato Grosso?\n\n```{r unknown}\namz_var_clim <- readxl::read_excel(here::here(\"dados\", \"madeira_amz_var_clim.xlsx\"), sheet = 1)\nhead(amz_var_clim) #leitura das primeiras 6 linhas\nstr(amz_var_clim) #Estrutura dos dados\n\n\n#Tratando NAs\nd13.amz <- amz_var_clim[!is.na(amz_var_clim$d13C_wood), ]\n\n# Adicionando ID\nd13.amz$ID <- 1:nrow(d13.amz)\n\nd13.amz <- d13.amz %>% relocate(ID, .before = 1)\n\nunknown <- d13.amz[d13.amz$ID== 103,]\nunknown$d13C_wood\n```\n\nDado o valor medido, como você julgaria qual unidade é a origem mais provável? A maioria dos algoritmos de classificação simples usa uma métrica de distância para avaliar a similaridade entre o valor da amostra e as classes possíveis, atribuindo então a amostra à classe mais similar. Por exemplo:\n\n```{r invDiff}\nfus.mu$inv.diff <- 1 / abs(unknown$d13C_wood - fus.mu[, 2])\nfus.mu\n```\n\nCom base no inverso da distância podemos admitir que é mais coerente essa amostra\nser do Amazonas. Vejamos mais alguns detalhes:\n\n:::{#fuDist}\n```{r fuDist}\n#| fig-width: 6\n#| fig-height: 4\n\ncols = viridis(2, begin = 0.2, end = 0.8)\nfus.all = extract(iso_d13, fus)\nd1 = density(fus.all[fus.all$ID == 1, 2], na.rm = TRUE)\nd2 = density(fus.all[fus.all$ID == 2, 2], na.rm = TRUE)\nplot(d1, xlim = range(fus.all[, 2], na.rm = TRUE), \n     ylim = range(c(d1$y, d2$y)), main = \"\", \n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), col = cols[1], lwd = 3)\nlines(d2, col = cols[2], lwd = 3)\nabline(v = unknown$d13C_wood, lwd = 3, lty = 3)\nlegend(\"topleft\", fu.names, lwd = 3, col = cols, bty = \"n\")\n```\n:::\n\nNote que agora as coisas parecem um pouco diferentes. O que não percebemos antes, quando avaliamos apenas as médias, é que as `d13C_wood` previsões para Mato Grosso estão restritas a uma faixa estreita de valores, enquanto as do Amazonas são muito mais dispersas. Como resultado, o valor da amostra desconhecida tem, na verdade, uma probabilidade maior de ocorrer no Amazonas. Podemos avaliar a diferença entre as probabilidades extraindo a densidade de probabilidade do valor da amostra por mil dos kernels para as duas regiões:\n\n:::{#fuRatio}\n```{r fuRatio}\np1 <- d1$y[which.min(abs(unknown$d13C_wood - d1$x))]\np2 <- d2$y[which.min(abs(unknown$d13C_wood - d2$x))]\ncat(\"PD Amazonas = \", p1, \"\\nPD Mato Grosso = \", p2, \"\\nRatio = \", p1 / p2)\n```\n:::\n\nIsso demonstra que a probabilidade de encontrar esse valor no Amazonas é muito maior do que no Mato Grosso, levantando a hipotese que realmente o Amazonas seja a região de origem mais provável.\n\nPodemos ir um passo além, no entanto, aplicando o Teorema de Bayes para fazer uma afirmação quantitativa sobre a probabilidade de cada unidade ser a verdadeira região de origem, partirmos das seguintes premissas:\n\n1) Nossa amostra desconhecida deve ter vindo de um dos dois estados, e\n\n2) Antes de considerarmos nossos dados isotópicos, ambos os estados têm a mesma probabilidade de serem a verdadeira origem.\n\nO Teorema de Bayes nos diz que a probabilidade de uma determinada região ser a verdadeira região de origem é igual à probabilidade de observarmos nossos dados isotópicos nessa região dividida pela probabilidade de observarmos os dados em qualquer uma das regiões. Acabamos de determinar as probabilidades para os dados acima, o que torna esse cálculo muito fácil:\n\n```{r fuPost}\ndata.frame(\"Region\" = fu.names, \"Probalidade_posteiro\" = \n             c(p1 / sum(p1, p2), p2 / sum(p1, p2)))\n```\n\nA probabilidade posterior é a probabilidade após considerarmos nossas novas evidências (isotópicas) e, como você pode ver aqui, ela sugere que há uma alta probabilidade (99%) de que nossa amostra desconhecida seja do Amazonas e não do Mato Grosso. Se quisermos 'atribuir' a amostra a uma região de origem mais provável, escolheríamos o Amazonas.\n\nResumindo nosso exemplo, a chave para atribuir a amostra a uma região geográfica é encontrar a probabilidade de nossa evidência (o valor da amostra `d13C_wood`) ocorrer em cada uma de nossas potenciais regiões de origem. Com essa informação, podemos aplicar o Teorema de Bayes para encontrar a probabilidade de cada região ser a verdadeira origem.\n\n\n## Isoscapes baseados em probabilidade\n\nUsando a isoscape gerada pelo modelo RF vamos considerar cada célula da grade no mapa de isótopos separadamente como uma possível localização de onde nossa amostra pode ter se originado. \n\nUma das implicações dessa abordagem é que agora estamos considerando um número muito grande de possíveis locais de origem. Esse número dependerá da extensão e da resolução do nosso mapa isotópico, mas, neste exemplo, o número é:\n\n```{r nCell}\nsum(!is.na(values(iso_d13[[1]])))\n\n# Cada pixel tem aproximadamente 85 km2\nterra::res(iso_d13[[1]])\n```\nConsequentemente, a probabilidade de qualquer célula da grade ser a localização real de origem será bastante pequena. Por exemplo, se nossa suposição inicial for que cada célula da grade tem a mesma probabilidade de ser a verdadeira origem da amostra, cada célula terá uma probabilidade de:\n\n```{r cellProb}\n1 / sum(!is.na(values(iso_d13[[1]])))\n```\nEsses pequenos valores de probabilidade confundem um pouco, mas podemos ver aqui como eles surgem e que são esperados. Em geral, não estaremos interessados nos valores de probabilidade em si, mas na magnitude relativa das probabilidades para diferentes locais.\n\nPara aplicar nosso método baseado em probabilidade às células da grade do mapa de isótopos, precisamos conhecer as distribuições de probabilidade dos `d13C_wood` valores em cada célula. Nesse caso, vamos assumir a suposição de normalidade.\n\nPara realizar a análise (e ao longo do restante desta vinheta), usaremos funções do\n[`assignR` package](https://cran.r-project.org/package=assignR).\n\n```{r pdRaster}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nsam <- data.frame(\"ID\" = unknown$ID, \"d13C\" = unknown$d13C_wood)\np.map1 <-  pdRaster(iso_d13, sam, genplot = FALSE)\nuk.sp <- vect(unknown, geom = c(\"x\", \"y\"), crs = \"EPSG:4674\")\nfu.sub <- fu[fu$ADM1_PT %in% fu.names]\n\nplot(p.map1, axes = FALSE)\nlines(fu.sub, lwd = 2)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 2, lwd = 2, bg = \"white\")\n```\nO mapa mostra a localização de origem verdadeira e conhecida desta amostra. É possível observar que ela não se encontra em uma região com probabilidade posterior particularmente alta. Também não está na região com as probabilidades mais baixas. Podemos extrair o valor real para esta localização, que se situa no meio do intervalo obtido na análise:\n\n```{r rastProb}\nextract(p.map1, uk.sp)\n```\n\n\n\n## Inferência\n\nAlgumas perguntas:\n\n- 1) *De onde veio a amostra*? \n\n- 2) *Quais são os locais de origem mais prováveis*?\n\nA função `qtlRaster()` oferece duas opções para tentar responder essas questões,\na primeira (e padrão) baseada na área do mapa:\n\n```{r qt1}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nqt1 <- qtlRaster(p.map1, threshold =0.5, genplot = FALSE)\n\nplot(qt1, axes = FALSE)\nlines(fu.sub)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 1.5, lwd = 2, bg = \"white\")\n```\n\nAqui extrairmos 50% da área de estudo, gerando mapas que mostram os 50% das \ncélulas da grade com a maior probabilidade posterior a amostra.\n\nA segunda opção de atribuição é um pouco menos arbitrária e envolve a seleção das células mais prováveis da malha isotópica que representam coletivamente uma certa quantidade da probabilidade posterior. Neste caso, escolhemos um valor de 0,95. Assim, podemos interpretar diretamente o resultado: tendo em conta os dados e os pressupostos da nossa análise, existe uma probabilidade de 95% de a amostra provir da área selecionada.\n\n\n\n:::{#qt2}\n```{r qt2}\n#| fig.align: center\n#| fig.show: hold\n#| fig.asp: 0.6\n#| out.width: \"90%\"\n#| fig.margin: FALSE\nqt2<-qtlRaster(p.map1, threshold = 0.95, thresholdType = \"prob\", genplot = FALSE)\n\nplot(qt2, axes = FALSE)\nlines(fu.sub)\n#lines(brazil, lwd = 2)\npoints(uk.sp, pch = 21, cex = 1.5, lwd = 2)\n\nextract(qt2, uk.sp)\n```\n:::\n\nComo você pode ver, precisamos selecionar mais de 50% da área de estudo para atingir nosso limiar de probabilidade de 95%. Também é possível observar que, neste caso, a verdadeira localização de origem está incluída na região de atribuição.  Sempre haverá muitos locais onde um determinado valor pode ocorrer, mas pode ser bastante óbvio quando o valor de uma amostra não corresponde bem a um determinado local.\n\nUsando a razão de chances podemos responder Qual unidade federativa é a localização de origem mais provável, Amazonas ou Mato Grosso? \n\n\n```{r odds}\noddsRatio(p.map1, fu.sub)\n```\nHá dois pontos a observar aqui:\n\n- A razão de chances indica que é 1,7 vezes mais provável que a amostra tenha vindo do Amazonas (que por acaso é o verdadeiro local de origem).\n\n\n```{r pdDist}\n#| fig-width: 6\n#| fig-height: 4\n\npts = sample(which(fus.all$ID == 1), 5)\npts = c(pts, sample(which(fus.all$ID == 2), 5))\n\nplot(NULL, xlim = c(-32, -26), ylim = c(0, 0.7), \n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), ylab = \"Density\")\n\nfor(i in pts){\n  lines(density(rnorm(1e6, fus.all[i, 2], fus.all[i, 3])), lwd = 3, \n        col = cols[fus.all[i, 1]])\n}\nabline(v = unknown$d13C_wood, lwd = 3, lty = 3)\nlegend(\"topleft\", fu.names, lwd = 3, col = cols, bty = \"n\")\n\n```\n\n\nNossa análise de probabilidade de isótopos adiciona um fator importante que ignoramos implicitamente na análise de classificação original: a incerteza da previsão. Lembre-se de que nossos modelos de isótopos explicam apenas cerca de metade da `d13C_wood` variabilidade. A variação restante provém de duas fontes:\n\n- Erro do modelo - nosso modelo é imperfeito e não representa perfeitamente o padrão de `d13C_wood` valores médios na área de estudo.\n\n- Variabilidade local - árvores individuais que vivem no mesmo local podem apresentar valores que variam em vários por mil. Por exemplo, aqui está a distribuição de valores para árvores individuais da mesma família e local de coleta que nossa amostra de teste desconhecida:\n\n\n```{r variance}\nplot(density(d13.amz$d13C_wood[d13.amz$Family == unknown$Family & \n                               d13.amz$Site == unknown$Site]),\n     xlab = expression(delta^{13}*\"C\"[\"wood\"]), main = \"\", lwd = 2)\n```\nSe quisermos avaliar se uma amostra pode ter vindo deste local com base em seu `d13C_wood` valor, é importante conhecer o valor médio do local, mas também precisamos considerar a dispersão: claramente, valores que variam de -34 a -26 por mil são plausíveis neste local.\n\n### Qualidade da atribuição\n\n\n```{r QA}\n#| output: false\n\nknown <- d13.amz[d13.amz$Family == \"Burseraceae\", c(\"x\", \"y\", \"d13C_wood\")]\nknown <- vect(known, geom = c(\"x\", \"y\"), crs = \"EPSG:4674\")\nqa1 <- QA(known, iso_d13, bySite = FALSE, recal = FALSE)\n```\n```{r plotQA}\n#| layout-ncol: 2\n\nplot(qa1)\n```\n\n\n\n\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":5,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"04_assign.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","title":"Atribuição","author":"Deoclecio J. Amorim (CENA), João Paulo Sena-Souza (Unimontes) e Paulo José Duarte Neto (UFRPE)","knitr":{"opts_chunk":{"fig-align":"center"}},"page-layout":"full","toc-location":"left"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":[]}