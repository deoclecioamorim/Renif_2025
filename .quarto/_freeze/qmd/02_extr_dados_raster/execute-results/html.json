{
  "hash": "4c4463319a92fabea5bb4a71fbce46a0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Extração de dados climáticos de arquivos raster\"\nauthor: \"Deoclecio J. Amorim (CENA), João Paulo Sena-Souza (Unimontes) e Paulo José Duarte Neto (UFRPE)\"\nformat:\n  html:\n    page-layout: full       # usa toda a largura da janela\n    toc: true\n    toc-location: left\n    fig-width: 5\n    fig-height: 5\nknitr: \n  opts_chunk: \n    fig-align: center\n---\n\n\n\n## Introdução\n\nEste documento apresenta o processo para extrair variáveis climáticas a partir \nde arquivos raster. Usamos os pacotes `sf` e `terra` para manipulação espacial\ne `writexl` para exportação.\n\n---\n\n## 1. Configuração inicial\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Limpar ambiente\nrm(list = ls())      \ngc(reset = TRUE)     \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          used (Mb) gc trigger (Mb) max used (Mb)\nNcells  607636 32.5    1386018 74.1   607636 32.5\nVcells 1106312  8.5    8388608 64.0  1106312  8.5\n```\n\n\n:::\n\n```{.r .cell-code}\ngraphics.off()       \n\n# Pacotes necessários\nif(!require(readxl))install.packages(\"readxl\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: readxl\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(tidyverse))install.packages(\"tidyverse\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: tidyverse\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.0.4     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(terra))install.packages(\"terra\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: terra\nterra 1.8.50\n\nAnexando pacote: 'terra'\n\nO seguinte objeto é mascarado por 'package:tidyr':\n\n    extract\n\nO seguinte objeto é mascarado por 'package:knitr':\n\n    spin\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(geodata))install.packages(\"geodata\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: geodata\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(geobr))install.packages(\"geobr\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: geobr\nCarregando namespace exigido: sf\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(sf))install.packages(\"sf\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: sf\nLinking to GEOS 3.13.1, GDAL 3.10.2, PROJ 9.5.1; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(sp))install.packages(\"sp\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: sp\n```\n\n\n:::\n\n```{.r .cell-code}\nif(!require(here))install.packages(\"here\", dep = TRUE, quiet = TRUE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: here\nhere() starts at C:/Users/DELL/OneDrive/Documentos/Cena/Cursos_Extensao_CENA/renif_2025\n```\n\n\n:::\n:::\n\n\n---\n\n## 2. Importação de dados isotópicos\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Caminho do arquivo de dados\nmadeira_path <- here(\"dados\",\"madeiras.csv\")\n\n# Caminho do arquivo de dados\nmadeira_amz <- read.csv(madeira_path, header = TRUE)\ncolnames(madeira_amz)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"X\"                  \"ID\"                 \"Cod.Lab\"           \n [4] \"Code\"               \"Species\"            \"Scientific_name\"   \n [7] \"Genus\"              \"Family\"             \"Point\"             \n[10] \"Site\"               \"State\"              \"UC\"                \n[13] \"date.sample.havest\" \"latitude\"           \"longitude\"         \n[16] \"d15N_wood\"          \"N_wood\"             \"d13C_wood\"         \n[19] \"C_wood\"             \"d13C_cel\"           \"C_cel\"             \n[22] \"d18O\"               \"Sr\"                 \"map\"               \n[25] \"mat\"                \"vap\"                \"d15N_soil\"         \n[28] \"dem\"                \"pet\"                \"d15N_foliar\"       \n[31] \"isorix\"             \"vpd\"                \"d13C_foliar\"       \n[34] \"rh\"                 \"soil_moisture\"      \"aet\"               \n[37] \"def\"                \"pa\"                \n```\n\n\n:::\n\n```{.r .cell-code}\n# data clean\nmadeira_amz <- madeira_amz %>% dplyr::select(\"latitude\", \"longitude\",\"Site\", \"Family\",\"d13C_wood\")\n```\n:::\n\n\n---\n\n## 3. Conversão para objeto espacial `sf`\n\nNessa etapa, é importante garantir que os dados estejam na mesma projeção dos \narquivos raster, a fim de minimizar os erros durante o processo de extração.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Converter para objeto sf com CRS SIRGAS 2000 (EPSG:4674)\nmadeira_amz_proj <- sf::st_as_sf(madeira_amz , coords = c(\"longitude\", \"latitude\"), crs = 4674)\n\n# Visualizar pontos\nplot(madeira_amz_proj[1], pch = 20, col = \"black\", main = NA, axes = TRUE, graticule = TRUE)\n```\n\n::: {.cell-output-display}\n![](02_extr_dados_raster_files/figure-html/unnamed-chunk-2-1.png){fig-align='center' width=480}\n:::\n:::\n\n\n---\n\n## 4. Carregamento e empilhamento de rasters\n\nLembre-se de que agora vamos utilizar os arquivos raster gerados na etapa anterior, \nos quais foram armazenados na pasta **raster**. \n\nO processo a seguir irá criar um único raster multicamada utilizando a \nfunção `rast` do pacote `terra`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Listar arquivos raster na pasta\nraster_files <- list.files(path = here(\"raster\"), pattern = \"\\\\.tif$\", full.names = TRUE)\n\n# Carregar como objetos raster\nraster_list <- lapply(raster_files, terra::rast)\n\n# Empilhar como SpatRaster\nr_stack <- terra::rast(raster_list)\n\n# Nomear camadas com base nos arquivos\nnames(r_stack) <- tools::file_path_sans_ext(basename(raster_files))\n```\n:::\n\n\n---\n\n## 5. Projeção e extração dos valores climáticos\n\nCom o raster multicamada obtido, podemos realizar a extração dos valores climáticos de acordo com as coordenadas de interesse. \n\nA função `extract`, do pacote `terra`, oferece dois métodos para extrair valores em pontos: **“simples”** e **“bilinear”**. \n\n- No modo **simples**, é retornado o valor da célula raster em que o ponto se encontra.\n- No modo **bilinear**, o valor retornado é uma interpolação bilinear calculada a partir das quatro células raster mais próximas do ponto.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Reprojetar raster se necessário\nif (!sf::st_crs(madeira_amz_proj) == sf::st_crs(r_stack)) {\n  r_stack <- terra::project(r_stack, sf::st_crs(madeira_amz_proj)$wkt)\n}\n\n# Extrair valores\nextracted_values <- terra::extract(r_stack, madeira_amz_proj, method = \"bilinear\")\n\n# Combinar com dados originais\nmadeira_amz_proj <- cbind(madeira_amz_proj, extracted_values[, -1])\n```\n:::\n\n\n---\n\n## 6. Exportação do conjunto final\n\nA etapa final consiste em exportar a planilha de dados e dar início ao processo de modelagem, com a implementação dos modelos estatísticos.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Extrair coordenadas\ncoordinates <- sf::st_coordinates(madeira_amz_proj)\n\n# Converter para data.frame e reorganizar\nmadeira_amz_proj_df <- madeira_amz_proj %>%\n  sf::st_drop_geometry() %>%\n  dplyr::mutate(x = coordinates[, 1], y = coordinates[, 2]) %>%\n  dplyr::relocate(x, y)\n\n# Criar pasta (caso não exista)\nif (!dir.exists(here(\"dados\"))) dir.create(here(\"dados\"))\n\n\n# Exportar para Excel\nwritexl::write_xlsx(madeira_amz_proj_df, here(\"dados\", \"madeira_amz_var_clim.xlsx\"))\n\n# Visualizar primeiras linhas\nhead(madeira_amz_proj_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        x      y                     Site        Family d13C_wood elev_mean\n1 -67.013 -0.121 São Gabriel da Cachoeira Myristicaceae        NA  85.35354\n2 -67.013 -0.121 São Gabriel da Cachoeira Myristicaceae        NA  85.35354\n3 -67.013 -0.121 São Gabriel da Cachoeira Myristicaceae        NA  85.35354\n4 -67.013 -0.121 São Gabriel da Cachoeira Myristicaceae        NA  85.35354\n5 -67.013 -0.121 São Gabriel da Cachoeira Myristicaceae        NA  85.35354\n6 -66.872 -0.041 São Gabriel da Cachoeira   Burseraceae        NA  93.38595\n  prec_mean srad_mean tavg_mean tmax_mean tmin_mean vapr_mean\n1  234.4459  14214.33  26.02067  30.85448  21.18930  2.883497\n2  234.4459  14214.33  26.02067  30.85448  21.18930  2.883497\n3  234.4459  14214.33  26.02067  30.85448  21.18930  2.883497\n4  234.4459  14214.33  26.02067  30.85448  21.18930  2.883497\n5  234.4459  14214.33  26.02067  30.85448  21.18930  2.883497\n6  230.3205  14185.80  26.11746  30.98413  21.24785  2.883914\n```\n\n\n:::\n:::\n\n\n---\n\n## Considerações finais\n\nO procedimento descrito neste capítulo é útil para preparar conjuntos de dados georreferenciados com atributos climáticos, os quais podem ser utilizados em análises espaciais ou como variáveis preditoras em modelos de machine learning.\n",
    "supporting": [
      "02_extr_dados_raster_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}